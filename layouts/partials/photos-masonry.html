{{- $singleImage := .Site.Params.single_image | default false }}
{{- $photosCategory := .Site.Params.photos_category | default "Photo" }}
{{- $category := index .Site.Taxonomies.categories (lower $photosCategory) }}
{{- $list := slice }}
{{- if $category }}
	{{- $list = $category.Pages }}
{{- else }}
	{{- $list = where .Site.Pages "Params.categories" "intersect" (slice $photosCategory) }}
{{- end }}
{{- $len := (len $list) }}
{{- $currentYearMonth := "" }}
{{- range sort $list "Date" "desc" }}
	{{- $year := .Date.Format "2006" }}
	{{- $month := .Date.Format "01" }}
	{{- $yearMonth := printf "%s-%s" $year $month }}
	{{- $monthName := .Date.Format "January" }}
	{{- if ne $currentYearMonth $yearMonth }}
		{{- if ne $currentYearMonth "" }}
		</ul>
		{{- end }}
		<h3 class="archive-range" data-year="{{ $year }}" data-year-month="{{ $yearMonth }}">{{ $monthName }} {{ $year }}</h3>
		<ul class="masonry-grid">
		{{- $currentYearMonth = $yearMonth }}
	{{- end }}
	{{- $postPermalink := .Permalink }}
	{{- $images := partial "get-images.html" . }}
	{{- if $singleImage }}
		{{- with (first 1 $images) }}
			{{ range . }}
			<li>
				<a href="{{ $postPermalink }}">
					<img src="{{ . }}" loading="lazy" />
				</a>
			</li>
			{{ end }}
		{{- end }}
	{{- else }}
		{{ range $images }}
		<li>
			<a href="{{ $postPermalink }}">
				<img src="{{ . }}" loading="lazy" />
			</a>
		</li>
		{{ end }}
	{{- end }}
{{- end }}
</ul>
<script>
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}
	function handleImage(imageElement) {
		if (!imageElement) return;
		const listItem = imageElement.closest('li');
		imageElement.addEventListener('load', function() {
			listItem.classList.add('loaded');
			imageElement.classList.add('visible');
		});
		imageElement.addEventListener('error', function() {
			listItem.innerHTML = 'Failed to load image';
			listItem.style.padding = '2rem';
			listItem.style.textAlign = 'center';
		});
		if (imageElement.complete) {
			listItem.classList.add('loaded');
			imageElement.classList.add('visible');
		}
	}
	const observer = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				const img = entry.target;
				handleImage(img);
				observer.unobserve(img);
			}
		});
	}, {
		rootMargin: '50px'
	});
	document.querySelectorAll('.masonry-grid img').forEach(img => {
		if (img.loading === 'lazy') {
			observer.observe(img);
		} else {
			handleImage(img);
		}
	});
</script>
