{{ define "main" }}
<main class="photos{{ if .Site.Params.full_width_photos }}{{ print "-wide" }}{{ end }}">
	<article>
		<h1 class="page-title">{{ .Title | safeHTML }}</h1>
		{{- with .Content }}
		<div class="microblog-category-intro">{{ . | safeHTML }}</div>
		{{- end }}
		{{- $allFormats := .Site.Params.all_formats }}
		{{- $singleImage := .Site.Params.single_image | default false }}
		{{- $list := where .Pages ".Params.photos" "!=" nil }}
		{{- $len := (len $list) }}
		{{- $currentYearMonth := "" }}
		{{- range sort $list "Date" "desc" }}
			{{- $year := .Date.Format "2006" }}
			{{- $month := .Date.Format "01" }}
			{{- $yearMonth := printf "%s-%s" $year $month }}
			{{- $monthName := .Date.Format "January" }}
			{{- if ne $currentYearMonth $yearMonth }}
				{{- if ne $currentYearMonth "" }}
				</ul>
				{{- end }}
				<h3 class="archive-range" data-year="{{ $year }}" data-year-month="{{ $yearMonth }}">{{ $monthName }} {{ $year }}</h3>
				{{- if $.Site.Params.masonry_layout }}
				<ul class="masonry-grid">
				{{- else }}
				<ul class="grid">
				{{- end }}
				{{- $currentYearMonth = $yearMonth }}
			{{- end }}
			{{- $postPermalink := .Permalink }}
			{{- if $singleImage }}
				{{- with (first 1 .Params.photos) }}
					{{ range . }}
					<li>
						<a href="{{ $postPermalink }}">
							<img src="{{ . }}" loading="lazy" />
						</a>
					</li>
					{{ end }}
				{{- end }}
			{{- else }}
				{{ range .Params.photos }}
				<li>
					<a href="{{ $postPermalink }}">
						<img src="{{ . }}" loading="lazy" />
					</a>
				</li>
				{{ end }}
			{{- end }}
		{{- end }}
		</ul>
		{{- if .Site.Params.masonry_layout }}
		<script>
			function debounce(func, wait) {
				let timeout;
				return function executedFunction(...args) {
					const later = () => {
						clearTimeout(timeout);
						func(...args);
					};
					clearTimeout(timeout);
					timeout = setTimeout(later, wait);
				};
			}
			function handleImage(imageElement) {
				if (!imageElement) return;
				const listItem = imageElement.closest('li');
				imageElement.addEventListener('load', function() {
					listItem.classList.add('loaded');
					imageElement.classList.add('visible');
				});
				imageElement.addEventListener('error', function() {
					listItem.innerHTML = 'Failed to load image';
					listItem.style.padding = '2rem';
					listItem.style.textAlign = 'center';
				});
				if (imageElement.complete) {
					listItem.classList.add('loaded');
					imageElement.classList.add('visible');
				}
			}
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const img = entry.target;
						handleImage(img);
						observer.unobserve(img);
					}
				});
			}, {
				rootMargin: '50px'
			});
			document.querySelectorAll('.masonry-grid img').forEach(img => {
				if (img.loading === 'lazy') {
					observer.observe(img);
				} else {
					handleImage(img);
				}
			});
		</script>
		{{- else }}
		<script>
			const elementsToResize = new Set();
			function debounce(func, wait) {
				let timeout;
				return function executedFunction(...args) {
					const later = () => {
						clearTimeout(timeout);
						func(...args);
					};
					clearTimeout(timeout);
					timeout = setTimeout(later, wait);
				};
			}
			function resizeAllElements() {
				elementsToResize.forEach(element => {
					if (element.isConnected) {
						element.style.height = element.offsetWidth + 'px';
					} else {
						elementsToResize.delete(element);
					}
				});
			}
			const debouncedResize = debounce(resizeAllElements, 100);
			window.addEventListener('resize', debouncedResize);
			function resizeImageHeight(imageElement) {
				if (!imageElement) return;
				elementsToResize.add(imageElement);
				const listItem = imageElement.closest('li');
				imageElement.addEventListener('load', function() {
					imageElement.style.height = imageElement.offsetWidth + 'px';
					listItem.classList.add('loaded');
					imageElement.classList.add('visible');
				});
				imageElement.addEventListener('error', function() {
					elementsToResize.delete(imageElement);
					listItem.innerHTML = 'Failed to load image';
					listItem.style.padding = '2rem';
					listItem.style.textAlign = 'center';
				});
				if (imageElement.complete) {
					imageElement.style.height = imageElement.offsetWidth + 'px';
					listItem.classList.add('loaded');
					imageElement.classList.add('visible');
				}
			}
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const img = entry.target;
						resizeImageHeight(img);
						observer.unobserve(img);
					}
				});
			}, {
				rootMargin: '50px'
			});
			document.querySelectorAll('.grid img').forEach(img => {
				if (img.loading === 'lazy') {
					observer.observe(img);
				} else {
					resizeImageHeight(img);
				}
			});
		</script>
		{{- end }}
	</article>
</main>
{{ end }}
